---
date: "2024-06-28T12:08:32+03:00"
description: ""
id: uvn20fzeroorbugcnzklqbt
publish: true
title: Chan
updated: 1719570527174
---

<https://www.youtube.com/watch?v=ZTJcaP4G4JM>

- свойства каналов

  - потокобезопасные (горутинобеззопасные)
  - FIFO семантика
  - используются для передачи данных между горутинами
  - производят блокировку горутин

- буферизированный канал
  - состоит из
    - кольцевая очередь `buf` ( находится heap )
    - два указателя
      - один на запись `sendx`
        - всегда смещается на +1 индекс при записи
        - если достиг конца буфера - возвращается на 0 индекс
          - это сделано, чтобы не сдвигать никак элементы в памяти
      - один на чтение `recvx`
        - всегда смещается на +1 индекс при чтении
        - если достиг конца буфера - возвращается на 0 индекс
          - это сделано, чтобы не сдвигать никак элементы в памяти
    - мьютекс при добавлении и чтении из очереди `lock`
  - действие при заполнении буфера ( пишущая горутина доходит до заполненной ячейки )
    - планировщик делает `gopark()` для пишущей горутины
    - пишущая горутина добавляется в очередь `sendq` желающих на запись в канал
      - очередь `sendq` - связный список
      - добавление происходит в виде структуры `sudog`
    - когда читающая горутина доходит до элемента, в который хочет писать пишущая горутина
      - читающая горутина читает текущий элемент в канале
      - читающая горутина будит пишущую горутину с помощью планировщика `goready()`
        - пишущая горутина попадает в очередь `runq`
        - фича заключается в том, что пробуждением горутин занимается именно читающая горутина, поэтому не нужно трогать мьютекс и блокировать
  - действие при пустом буфере ( читающая горутина смотрит на пустую ячейку )
    - планировщик делает `gopark()` для читающей горутины
    - читающая горутина добавляется в очередь `recvq` желающих на чтение из канала
      - очередь `recvq` - связный список
      - добавление происходит в виде структуры `sudog`
    - пишущая горутина напрямую передает данные напрямую в stack читающей спящей горутине с помощью `sendDirect()` ( чтобы избежать двойного копирования - сначала в буфер, а потом из буфера на чтение )
- небуферизированный канал
  - буфера нет
  - напрямые передаются между stack читателя и писателя с помощью `sendDirect()`
- закрытие канала
  - освобождение всех читателей и писателей
- посмотреть на код можно в `runtime/chan.go`

- планировщик
  - остановка горутины
  - пробуждение горутины
